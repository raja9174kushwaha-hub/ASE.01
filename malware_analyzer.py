import streamlit as st
import hashlib
import time
from collections import Counter
import math

def calculate_entropy(data: bytes) -> float:
    """Calculate Shannon entropy of bytes."""
    if not data:
        return 0.0
    counter = Counter(data)
    length = len(data)
    entropy = -sum((count / length) * math.log2(count / length) for count in counter.values())
    return entropy

def run_malware_analyzer_view():
    st.header("ðŸ¦  Malware Metadata Analyzer (Static)")
    st.markdown("Safely analyze file metadata, hashes, and entropy without execution via the **Static Analysis Engine**.")

    with st.container():
        st.subheader("ðŸ“¤ Artifact Ingestion")
        uploaded_file = st.file_uploader("Drop suspicious binary or script here", type=["exe", "dll", "pdf", "docx", "bin", "zip", "js", "py"])

    if uploaded_file is not None:
        with st.status("âš™ï¸ Processing Artifact...", expanded=True) as status:
            st.write("ðŸ” binary headers...")
            file_bytes = uploaded_file.read()
            # Fast processing, no artificial sleep needed mostly
            
            st.write("ðŸ”¢ calculating cryptographic digests...")
            md5 = hashlib.md5(file_bytes).hexdigest()
            sha1 = hashlib.sha1(file_bytes).hexdigest()
            sha256 = hashlib.sha256(file_bytes).hexdigest()
            
            st.write("ðŸ“Š measuring shannon entropy...")
            entropy = calculate_entropy(file_bytes)
            
            status.update(label="Analysis Complete", state="complete", expanded=False)

        # Heuristic Threat Scoring (Real Static Analysis)
        threat_score = 0
        risk_factors = []
        
        if entropy > 7.0:
            threat_score += 40
            risk_factors.append("High Entropy (Packed/Encrypted)")
        
        # Extension check
        if uploaded_file.name.lower().endswith(('.exe', '.dll', '.scr', '.vbs', '.js')):
             threat_score += 10
             risk_factors.append("Execuable Format")
             
        if len(file_bytes) < 2048:
             threat_score += 10
             risk_factors.append("Tiny File Size (Dropper/Shellcode?)")

        threat_level = "Info" if threat_score < 30 else ("Suspicious" if threat_score < 60 else "High Risk")
        threat_color = "normal" if threat_score < 30 else ("inverse" if threat_score > 60 else "off")

        st.markdown("### ðŸ§¬ Analysis Results")
        
        # Key Metrics
        m1, m2, m3, m4 = st.columns(4)
        m1.metric("File Size", f"{len(file_bytes) / 1024:.2f} KB", delta_color="off")
        m2.metric("Entropy Score", f"{entropy:.2f}", f"{'High' if entropy > 7 else 'Normal'}", delta_color="inverse")
        m3.metric("Type", uploaded_file.name.split('.')[-1].upper(), delta_color="off")
        m4.metric("Heuristic Score", f"{threat_score}/100", threat_level, delta_color=threat_color)
        
        st.markdown("---")
        
        # Detailed Layout
        col1, col2 = st.columns([1, 1])
        
        with col1:
            st.info(f"**File Name:** {uploaded_file.name}")
            if entropy > 7.0:
                st.error("ðŸš¨ **High Entropy Detected:** File is likely packed or encrypted, a common malware evasion technique.")
            else:
                st.success("âœ… **Normal Entropy:** File structure appears standard (not packed).")
            
            if risk_factors:
                st.warning(f"**Risk Factors:** {', '.join(risk_factors)}")

        with col2:
            with st.expander("ðŸ”‘ Cryptographic Hashes (IOCs)", expanded=True):
                st.code(f"MD5:    {md5}")
                st.code(f"SHA-1:  {sha1}")
                st.code(f"SHA-256: {sha256}")
                st.markdown(f"[ðŸ”Ž Search on VirusTotal](https://www.virustotal.com/gui/file/{sha256})")

